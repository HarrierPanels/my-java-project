pipeline {
    agent {
        label 'local1'
    }

    stages {
        stage('Fetch Docker Hub Tags') {
            steps {
                script {
                    // Define the Docker Hub image name
                    def dockerHubImageName = 'harrierpanels/myapp' // Replace with your Docker Hub image

                    // Make an HTTP GET request to fetch tags
                    def response = httpRequest(
                        url: "https://hub.docker.com/v2/repositories/${dockerHubImageName}/tags/",
                        httpMode: 'GET'
                    )

                    // Check if the request was successful
                    if (response.status == 200) {
                        // Parse the JSON response to get available tags
                        def tags = evaluateJson(response.content)
                        def availableVersions = tags.results.collect { it.name }

                        // Set the choices for the VERSION parameter
                        def versionChoices = availableVersions.join('\n')

                        // Define the parameters for version selection
                        choice(
                            choices: versionChoices,
                            description: 'Version number',
                            name: 'VERSION'
                        )
                    } else {
                        error("Failed to fetch Docker Hub tags: ${response.status} - ${response.content}")
                    }
                }
            }
        }

        stage('Build and Deploy') {
            steps {
                echo 'This is where you would add your build and deployment steps.'
                echo "Selected version: \${VERSION}"
            }
        }
    }
}

def evaluateJson(json) {
    def jsonSlurper = new groovy.json.JsonSlurper()
    return jsonSlurper.parseText(json)
}
