pipeline {
    agent {
        label 'local1'
    }

    parameters {
        choice(
            name: 'VERSION',
            choices: '',
            description: 'Select a version to deploy'
        )
    }

    stages {
        stage('Fetch Docker Hub Tags') {
            steps {
                script {
                    // Define the Docker Hub image name
                    def dockerHubImageName = 'harrierpanels/myapp' // Replace with your Docker Hub image

                    // Make an HTTP GET request to fetch tags
                    def response = httpRequest(
                        url: "https://hub.docker.com/v2/repositories/${dockerHubImageName}/tags/",
                        httpMode: 'GET'
                    )

                    // Check if the request was successful
                    if (response.status == 200) {
                        // Parse the JSON response to get available tags
                        def tags = evaluateJson(response.content)
                        def availableVersions = tags.results.collect { it.name }

                        // Set the choices for the VERSION parameter
                        currentBuild.setBuildParameters([VERSION: availableVersions.join('\n')])
                    } else {
                        error("Failed to fetch Docker Hub tags: ${response.status} - ${response.content}")
                    }
                }
            }
        }

        stage('Build and Deploy') {
            steps {
                echo "Selected version: ${params.VERSION}"
                // Add your build and deployment steps here using the selected version
            }
        }
    }
}

def evaluateJson(json) {
    def jsonSlurper = new groovy.json.JsonSlurper()
    return jsonSlurper.parseText(json)
}
